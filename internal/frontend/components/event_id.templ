package components

import (
    "git.iu7.bmstu.ru/ped22u691/PPO.git/internal/models/json_req_resp"
    // "time"
)

templ EventDetailsPage(tokenKey string, title string, event jsonreqresp.EventResponse, artworks []jsonreqresp.ArtworkResponse) {
    @UsersNavigate(title) {
        <div class="event-details-container">
            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ -->
            <div class="event-header">
                <h1>{ event.Title }</h1>
                <div class="event-meta">
                    <span class="event-date">
                        { event.DateBegin.Format("02.01.2006 15:04") } - { event.DateEnd.Format("02.01.2006 15:04") }
                    </span>
                    <span class="event-location">üìç { event.Address }</span>
                    <span class="event-status">
                        if event.CanVisit {
                            <span class="status-active">–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –ø–æ—Å–µ—â–µ–Ω–∏—è</span>
                        } else {
                            <span class="status-inactive">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –ø–æ—Å–µ—â–µ–Ω–∏—è</span>
                        }
                    </span>
                </div>
            </div>

            // if event.CanVisit {
            //     <!-- –ë–ª–æ–∫ —Å –±–∏–ª–µ—Ç–∞–º–∏ -->
            //     <div class="event-buy-tickets">
            //         <h3>–ë–∏–ª–µ—Ç—ã</h3>
            //         <p>–î–æ—Å—Ç—É–ø–Ω–æ –±–∏–ª–µ—Ç–æ–≤: { event.CntTickets }</p>
            //         if event.CanVisit && event.CntTickets > 0 {
            //             <button class="buy-ticket-button" onclick="showTicketModal()">–ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç</button>
            //         }
            //     </div>
            // }
            
            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∫—É–ø–∫–∏ –±–∏–ª–µ—Ç–∞ -->
            <div id="ticketModal" class="modal-buy">
                <div class="modal-content-buy">
                    <span class="close-buy" onclick="hideTicketModal()">&times;</span>
                    <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏ –±–∏–ª–µ—Ç–∞</h2>
                    <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –±–∏–ª–µ—Ç –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ "{ event.Title }"?</p>
                    <div class="modal-buttons-buy">
                        <button class="confirm-button-buy" onclick="confirmTicketPurchase()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                        <button class="cancel-button-buy" onclick="cancelTicketPurchase()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ -->
            <h2>–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –Ω–∞ –≤—ã—Å—Ç–∞–≤–∫–µ ({ len(event.ArtworkIDs) }):</h2>
            @ArtworksTable(artworks)

            <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
            <div class="back-button-container">
                <a href="/museum/events" class="back-button">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</a>
            </div>
        </div>

        <script>
            let currentTxId = null; // –•—Ä–∞–Ω–∏—Ç ID —Ç–µ–∫—É—â–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∫—É–ø–∫–∏ –±–∏–ª–µ—Ç–∞ (–≤—ã–∑–æ–≤ BuyTickets API)
            async function initTicketPurchase(eventId) {
                try {
                    console.log('initTicketPurchase:');
                    const response = await fetch('/api/v1/guest/tickets', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('@tokenKey')}`
                        },
                        body: JSON.stringify({
                            eventID: eventId,
                            cntTickets: 1, // –ü–æ–∫—É–ø–∞–µ–º 1 –±–∏–ª–µ—Ç
                            customerName: '', // –≠—Ç–∏ –ø–æ–ª—è –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
                            customerEmail: ''
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw error;
                    }
                    
                    const data = await response.json();
                    currentTxId = data.txID; // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                    showTicketModal();
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–∫—É–ø–∫–∏:', error);
                    alert(error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –ø–æ–∫—É–ø–∫—É –±–∏–ª–µ—Ç–∞');
                }
            }

            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏ (–≤—ã–∑–æ–≤ ConfirmBuyTicket API)
            async function confirmTicketPurchase() {
                if (!currentTxId) {
                    alert('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
                    return;
                }

                try {
                    const response = await fetch('/api/v1/guest/tickets/confirm', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('@tokenKey')}`
                        },
                        body: JSON.stringify({
                            txID: currentTxId
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw error;
                    }
                    
                    hideTicketModal();
                    alert('–ë–∏–ª–µ—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω!');
                    window.location.reload();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏:', error);
                    alert(error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–∫—É–ø–∫—É');
                } finally {
                    currentTxId = null;
                }
            }

            // –û—Ç–º–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏ (–≤—ã–∑–æ–≤ CancelBuyTicket API)
            async function cancelTicketPurchase() {
                if (!currentTxId) {
                    hideTicketModal();
                    return;
                }

                try {
                    const response = await fetch('/api/v1/guest/tickets/cancel', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('@tokenKey')}`
                        },
                        body: JSON.stringify({
                            txID: currentTxId
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw error;
                    }
                    
                    hideTicketModal();
                    alert('–ü–æ–∫—É–ø–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –ø–æ–∫—É–ø–∫–∏:', error);
                    alert(error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –ø–æ–∫—É–ø–∫—É');
                } finally {
                    currentTxId = null;
                }
            }

            // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            function showTicketModal() {
                document.getElementById('ticketModal').style.display = 'block';
            }

            // –°–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            function hideTicketModal() {
                document.getElementById('ticketModal').style.display = 'none';
            }

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            window.onclick = function(event) {
                const modal = document.getElementById('ticketModal');
                if (event.target == modal) {
                    cancelTicketPurchase();
                }
            }
        </script>
    }
}